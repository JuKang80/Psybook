<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>PsyBook | 로그인 및 개인정보 동의</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #ffffff;
    }
    .background-img {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
      opacity: 0.08;
      pointer-events: none;
    }
    .container {
      display: flex;
      flex-direction: row;
      width: 100%;
      min-height: 100vh;
    }
    .left, .right {
      flex: 1;
      padding: 40px;
      box-sizing: border-box;
    }
    .left {
      background-color: rgba(245, 245, 245, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      box-shadow: inset -10px 0 20px rgba(0,0,0,0.05);
    }
    .left .inner {
      margin: 0 auto;
      max-width: 400px;
    }
    .left h1 {
      margin-top: 0;
      font-size: 2.2em;
    }
    .left p {
      margin: 10px 0;
      line-height: 1.6;
    }
    .right {
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    form {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 300px;
    }
    input {
      margin-bottom: 15px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      outline: none;
    }
    button {
      padding: 10px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <img class="background-img" src="https://raw.githubusercontent.com/JuKang80/Psybook/main/knu_psy_logo.jpg" alt="배경">

  <!-- ▶▶ 로그인(Setup) 화면 ◀◀ -->
  <div class="container" id="setupView">
    <div class="left">
      <h1>📚 PsyBook</h1>
      <h3>심리학과 도서대여 웹서비스</h3>
      <p>
        <strong>운영기간:</strong> 평일과 주말 24시간<br>
        <strong>대상:</strong> 사회과학대학 204호 심리학과 과방 내 전공책 도서
      </p>
      <p>
        수집된 정보는 대여 관리 목적 외 다른 용도로 활용되지 않으며, 
        <strong>수집 이용의 목적 달성 시까지</strong> 보관됩니다.
      </p>
      <p style="color: red; font-weight: bold;">
        ❗ 사이트를 통하지 않고 무단 사용하거나 허위로 정보를 작성할 경우, 
        즉시 대여가 취소되며 앞으로의 이용이 제한될 수 있습니다.
      </p>
      <p>
        👉 <strong>대여사업 관리:</strong> <a href="tel:01021728496">010-2172-8496</a>
      </p>
      <p>
        본 서비스는 <strong>이름, 학번, 전화번호, 이메일</strong>을 수집하며, 
        도서 대여 이력 관리를 위해서만 사용됩니다.
      </p>
      <label>
        <input type="checkbox" id="agreeCheckbox"> 개인정보 수집 및 이용에 동의합니다.
      </label>
    </div>

    <div class="right">
      <form id="userForm">
        <input type="text" id="name" placeholder="이름" required>
        <input type="text" id="studentId" placeholder="학번" required>
        <input type="tel" id="phone" placeholder="전화번호" required>
        <input type="email" id="email" placeholder="이메일" required>
        <button type="submit" id="submitBtn" disabled>책 보러가기</button>
      </form>
    </div>
  </div>

  <!-- ▶▶ 라이브러리 화면 (초기에 숨김) ◀◀ -->
  <div id="libraryWrapper" style="display:none">
    <?!= include('library'); ?>
  </div>

<!-- ▽▽ 클라이언트 스크립트 ▽▽ -->
<script>
(() => {
  const form       = document.getElementById('userForm');
  const checkbox   = document.getElementById('agreeCheckbox');
  const submitBtn  = document.getElementById('submitBtn');
  const nameInput  = document.getElementById('name');
  const idInput    = document.getElementById('studentId');
  const phoneInput = document.getElementById('phone');
  const mailInput  = document.getElementById('email');

  /* ── 유틸 ── */
  const blank   = s => s.trim().length === 0;
  const emailOk = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
  const setBorder = (el, ok) => el.style.border = ok ? '1px solid #ccc' : '2px solid red';

  function validate() {
    const nv = !blank(nameInput.value);
    const iv = !blank(idInput.value);
    const pv = !blank(phoneInput.value);
    const ev = !blank(mailInput.value) && emailOk(mailInput.value);
    [ [nameInput,nv], [idInput,iv], [phoneInput,pv], [mailInput,ev] ].forEach(([el,ok]) => setBorder(el,ok));
    submitBtn.disabled = !(nv && iv && pv && ev && checkbox.checked);
  }

  validate();                                   // 초기 상태 반영
  [ nameInput, idInput, phoneInput, mailInput ].forEach(el => el.addEventListener('input', validate));
  checkbox.addEventListener('change', validate);

  /* ── 제출 ── */
  form.addEventListener('submit', evt => {
    evt.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = '저장 중…';

    google.script.run
      .withSuccessHandler(rowIdx => {
        /* 화면 전환 */
        document.getElementById('setupView').style.display   = 'none';
        document.getElementById('libraryWrapper').style.display = 'block';
        /* ▶︎ 배경 이미지 숨기기 (추가된 한 줄) */
        const bg = document.querySelector('.background-img');
        if (bg) bg.style.display = 'none';

        /* 세션 저장 & 라이브러리 초기화 */
        window._rowIdx = rowIdx;
        if (typeof initLibrary === 'function') initLibrary();
      })
      .withFailureHandler(err => {
        console.error(err);
        alert('저장 중 오류가 발생했습니다. 다시 시도해 주세요.');
        submitBtn.disabled = false;
        submitBtn.textContent = '책 보러가기';
      })
      .saveUserInfo(
        nameInput.value.trim(),
        idInput.value.trim(),
        phoneInput.value.trim(),
        mailInput.value.trim()
      );
  });
})();
</script>

</body>
</html>

